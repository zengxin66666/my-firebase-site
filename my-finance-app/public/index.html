<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TimeCure 财务额度看板</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- 引入 Chart.js 核心库 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- 引入 Chart.js 的 datalabels 插件 -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <!-- 新增：引入 SheetJS (xlsx) 库用于导出 Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      background: #f0f2f5;
      color: #333;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
    }
    .container {
      max-width: 1600px;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 25px;
      margin: 25px 0;
    }
    .client-card, .add-client-card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.07);
      padding: 25px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      transition: all 0.3s ease;
      border: 1px solid #e8e8e8;
    }
    .client-card:hover, .add-client-card:hover {
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      transform: translateY(-5px);
    }
    .add-client-card {
      justify-content: center;
      font-size: 70px;
      color: #a0a0a0;
      cursor: pointer;
      border: 2.5px dashed #d9d9d9;
      background: #fafafa;
      min-height: 450px;
    }
    .add-client-card:hover {
       color: #0d6efd;
       border-color: #0d6efd;
       background: #f0f8ff;
    }
    .client-pie {
      width: 180px;
      height: 180px;
      margin: 20px 0;
    }
    .pie-label-container {
      width: 100%;
      text-align: center;
      margin-top: 10px;
      min-height: 50px; /* 避免没标签时布局跳动 */
    }
    .pie-label {
      display: inline-block;
      font-size: 13px;
      margin: 0 8px 5px 0;
      padding: 3px 8px;
      border-radius: 12px;
      font-weight: 500;
      color: #fff;
    }
    .client-card .client-name {
      font-size: 1.8rem;
      font-weight: 700;
      color: #1a2747;
      margin-bottom: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
     .client-card .client-name:hover {
        color: #0d6efd;
     }
    .warning-badge, .danger-badge {
        font-size: 0.8rem;
        padding: 0.2em 0.6em;
        border-radius: 0.8em;
        color: #fff;
        font-weight: 600;
    }
    .warning-badge {
        background-color: #f7b731;
    }
    .danger-badge {
        background-color: #e74c3c;
    }
    .info-row {
      font-size: 1rem;
      color: #555;
      margin-bottom: 0.5rem;
    }
    .info-row b {
      color: #000;
      font-weight: 600;
    }
    .quota-bar-wrapper {
      width: 100%;
      height: 25px;
      margin-top: 15px;
      position: relative;
    }
    .quota-bar-bg {
      width: 100%;
      height: 100%;
      background: #e9ecef;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }
    .quota-bar-fill {
      height: 100%;
      border-radius: 8px;
      transition: width 0.6s ease-in-out;
      position: absolute;
      left: 0;
      top: 0;
    }
    .quota-bar-text {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 50%;
      transform: translateY(-50%);
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .dashboard-title {
      font-size: 2rem;
      font-weight: 700;
      color: #1a2747;
      margin-bottom: 1rem;
    }
    .action-bar {
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .modal-header {
      background: #1a2747;
      color: #fff;
    }
    .btn-close-white {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
  </style>
</head>
<body>
<div class="container py-4">
  <div id="main-view">
    <h1 class="dashboard-title">客户额度总览</h1>
    <div class="action-bar">
      <button class="btn btn-primary" id="addRecordBtn">添加消费记录</button>
      <button class="btn btn-outline-secondary" id="importBtn">导入数据</button>
      <button class="btn btn-outline-secondary" id="exportBtn">导出数据</button>
      <input type="file" id="importFile" accept=".json" style="display:none;">
    </div>
    <div class="dashboard" id="dashboard">
      <!-- 客户卡片将由JS动态生成 -->
    </div>
  </div>

  <div id="detail-view" style="display: none;">
      <h1 id="detail-title" class="dashboard-title"></h1>
      <div class="action-bar">
        <button class="btn btn-secondary" id="backToDashboardBtn">返回总览</button>
        <button class="btn btn-outline-primary" id="exportClientBtn">导出JSON</button>
        <!-- 新增：导出Excel按钮 -->
        <button class="btn btn-success" id="exportExcelBtn">导出Excel</button>
      </div>
       <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>日期</th><th>分类</th><th>项目</th><th>供应商</th>
              <th>数量</th><th>单价</th><th>总额</th><th>备注</th><th>操作</th>
            </tr>
          </thead>
          <tbody id="clientCostTableBody"></tbody>
        </table>
    </div>
  </div>
</div>

<!-- 添加/编辑记录模态框 -->
<div class="modal fade" id="recordModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="recordModalTitle">添加记录</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="recordForm">
          <input type="hidden" id="recordId">
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">日期</label><input type="date" class="form-control" id="recordDate" required></div>
            <div class="col-md-6"><label class="form-label">客户</label><select class="form-select" id="recordClient" required></select></div>
            <!-- 更新：分类改为带有分组的二级下拉框 -->
            <div class="col-md-6"><label class="form-label">分类</label><select class="form-select" id="recordCategory" required></select></div>
            <div class="col-md-6"><label class="form-label">项目</label><input type="text" class="form-control" id="recordItemName" placeholder="例如：第一季度补充剂" required></div>
            <div class="col-md-12"><label class="form-label">供应商</label><input type="text" class="form-control" id="recordSupplier"></div>
            <div class="col-md-4"><label class="form-label">数量</label><input type="number" class="form-control" id="recordQuantity" min="0" value="1" required></div>
            <div class="col-md-4"><label class="form-label">单价</label><input type="number" class="form-control" id="recordUnitPrice" min="0" step="0.01" required></div>
            <div class="col-md-4"><label class="form-label">总额</label><input type="number" class="form-control" id="recordTotalAmount" min="0" step="0.01" required readonly></div>
            <div class="col-md-12"><label class="form-label">备注</label><textarea class="form-control" id="recordNotes" rows="2"></textarea></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="saveRecordBtn">保存</button>
      </div>
    </div>
  </div>
</div>

<!-- 新增客户模态框 -->
<div class="modal fade" id="addClientModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">新增客户</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">客户姓名</label>
            <input type="text" class="form-control" id="newClientName" placeholder="例如：张三" required>
          </div>
          <div class="mb-3">
             <label class="form-label">客户类型</label>
             <select class="form-select" id="newClientType">
                <option value="基础版">基础版 (额度: 40,000)</option>
                <option value="Pro版">Pro版 (额度: 120,000)</option>
                <option value="特殊">特殊(手动输入额度)</option>
             </select>
          </div>
          <div class="mb-3" id="manualQuotaWrapper" style="display:none;">
            <label class="form-label">总额度</label>
            <input type="number" class="form-control" id="newClientQuota" min="0" placeholder="例如：150000">
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="saveNewClientBtn">保存客户</button>
      </div>
    </div>
  </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>您确定要删除这条记录吗？此操作不可撤销。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">确认删除</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

  const STORAGE_KEY = 'TimeCureFinanceData_v6';
  let data = {
    clients: [],
    costRecords: [],
  };

  // =================================================================
  // 权威分类标准
  // =================================================================
  const CATEGORY_STRUCTURE = {
    "实物成本": ["定制补充剂成本", "益生菌成本", "同源性荷尔蒙成本"],
    "方案成本": ["美国长寿方案成本", "医厅方案成本", "膳食方案成本", "方案研发/更新成本", "医疗方案成本"],
    "额外采买好物成本": ["额外采买好物成本"],
    "客户服务成本": ["拜访客户差旅费", "客户招待费", "其他客户服务费用", "拜访客户成本"],
    "检测成本": ["时光尺3.0", "时光尺2.0 NAD+", "16S肠道菌群", "其他检测项目", "检测成本", "NAD+"],
    "抗衰设备成本": ["设备采购成本", "设备维护成本", "抗衰设备使用成本"],
    "提成": ["提成"],
    "其他成本": ["其他成本"]
  };

  // 统一颜色映射
  const CATEGORY_COLORS = {
    "实物成本": "#ff6384",
    "方案成本": "#4bc0c0",
    "额外采买好物成本": "#ff9f40",
    "客户服务成本": "#c9cbcf",
    "检测成本": "#36a2eb",
    "抗衰设备成本": "#9966ff",
    "提成": "#ffce56",
    "其他成本": "#a3a3a3",
    "默认": "#6c757d"
  };

  // 反向映射：从子分类找到主分类
  const SUB_TO_MAIN_CATEGORY_MAP = {};
  for (const mainCat in CATEGORY_STRUCTURE) {
    CATEGORY_STRUCTURE[mainCat].forEach(subCat => {
      SUB_TO_MAIN_CATEGORY_MAP[subCat] = mainCat;
    });
  }
  
  // 将任何分类（新或旧）转换为标准大类的函数
  function getMainCategory(subCategory) {
    return SUB_TO_MAIN_CATEGORY_MAP[subCategory] || '其他成本';
  }
  // =================================================================


  // 预加载用户提供的数据
  const getUserData = () => ({
      clients: [
        {id: 1752204452461, name: "彭黎", startDate: "2025-06-09", type: "Pro版", createdAt: "2025-07-11T03:27:32.461Z"},
        {id: 1752206656090, name: "潘&徐", startDate: "2025-04-20", type: "Pro版", createdAt: "2025-07-11T04:04:16.090Z"},
        {id: 1752214184088, name: "王娴&王杰", startDate: "2025-07-01", type: "基础版", quota: 80000, createdAt: "2025-07-11T06:09:44.088Z"},
        {id: 1752214587578, name: "梅龙毅", startDate: "2025-06-26", type: "基础版", createdAt: "2025-07-11T06:16:27.578Z"},
        {id: 1752215330028, name: "吴边", startDate: "2024-10-15", type: "基础版", createdAt: "2025-07-11T06:28:50.028Z"}
      ],
      costRecords: [
        {id: 1752206309982, clientId: 1752204452461, date: "2025-07-11", category: "定制补充剂成本", itemName: "第一季度定制补充剂", supplier: "袁名远", quantity: 1, unitPrice: 2400, totalAmount: 2400, notes: "无", createdAt: "2025-07-11T03:58:29.982Z"},
        {id: 1752206410920, clientId: 1752204452461, date: "2025-07-11", category: "益生菌成本", itemName: "八周益生菌", supplier: "金裕", quantity: 1, unitPrice: 2357, totalAmount: 2357, notes: "2347，加上预估10元寄送运费", createdAt: "2025-07-11T04:00:10.920Z"},
        {id: 1752206509907, clientId: 1752204452461, date: "2025-07-11", category: "抗衰设备使用成本", itemName: "每月10次设备使用（一年）", supplier: "广州时光派", quantity: 1, unitPrice: 8000, totalAmount: 8000, notes: "", createdAt: "2025-07-11T04:01:49.907Z"},
        {id: 1752206865620, clientId: 1752204452461, date: "2025-07-11", category: "生物同源性荷尔蒙成本", itemName: "第一次荷尔蒙付款", supplier: "鲁博", quantity: 1, unitPrice: 10677, totalAmount: 10677, notes: "第一次面诊＋第一季度药费＋帮带费用", createdAt: "2025-07-11T04:07:45.620Z"},
        {id: 1752207459415, clientId: 1752206656090, date: "2025-05-09", category: "检测成本", itemName: "问题排查（包含各种检测）", supplier: "华测", quantity: 1, unitPrice: 7200, totalAmount: 7200, notes: "以下份数*2\n全套有机酸代谢分析\n营养与毒性元素分析\n混合过敏源20项\n上呼吸道感染EB病毒抗体检测四项\n病原抗体九项\n呼吸道核酸六联检\n肺炎支原体脱氧核糖核酸检测\n巨细胞病毒抗体IgM定量\n巨细胞病毒抗体IgG定量", createdAt: "2025-07-11T04:17:39.415Z"},
        {id: 1752207706427, clientId: 1752206656090, date: "2025-05-28", category: "检测成本", itemName: "16s肠道菌群检测", supplier: "金裕", quantity: 1, unitPrice: 1566, totalAmount: 1566, notes: "包含16s检测*2，含文印费、运费、耗材", createdAt: "2025-07-11T04:21:46.427Z"},
        {id: 1752207752471, clientId: 1752206656090, date: "2025-04-25", category: "检测成本", itemName: "时光尺3.0", supplier: "华测等", quantity: 1, unitPrice: 14558, totalAmount: 14558, notes: "成本*2", createdAt: "2025-07-11T04:22:32.471Z"},
        {id: 1752207834533, clientId: 1752206656090, date: "2025-04-25", category: "检测成本", itemName: "NAD+", supplier: "郎华", quantity: 1, unitPrice: 450, totalAmount: 450, notes: "检测+物流成本（225*2）", createdAt: "2025-07-11T04:23:54.533Z"},
        {id: 1752208815178, clientId: 1752204452461, date: "2025-06-20", category: "检测成本", itemName: "16s肠道菌群检测", supplier: "金裕", quantity: 1, unitPrice: 723, totalAmount: 723, notes: "无文印费和报告邮寄费", createdAt: "2025-07-11T04:40:15.178Z"},
        {id: 1752208931290, clientId: 1752206656090, date: "2025-01-21", category: "拜访客户成本", itemName: "上门拜访", supplier: "交通", quantity: 1, unitPrice: 880.09, totalAmount: 880.09, notes: "火车票818元+徐方倩打车62.09元", createdAt: "2025-07-11T04:42:11.290Z"},
        {id: 1752208994353, clientId: 1752206656090, date: "2025-02-12", category: "额外采买好物成本", itemName: "液体钙", supplier: "淘宝", quantity: 1, unitPrice: 917.5, totalAmount: 917.5, notes: "", createdAt: "2025-07-11T04:43:14.353Z"},
        {id: 1752209027372, clientId: 1752206656090, date: "2025-01-21", category: "拜访客户成本", itemName: "低糖水果", supplier: "水果", quantity: 1, unitPrice: 295.95, totalAmount: 295.95, notes: "", createdAt: "2025-07-11T04:43:47.372Z"},
        {id: 1752209066166, clientId: 1752206656090, date: "2025-03-15", category: "拜访客户成本", itemName: "线下招待果切", supplier: "水果", quantity: 1, unitPrice: 22.8, totalAmount: 22.8, notes: "", createdAt: "2025-07-11T04:44:26.166Z"},
        {id: 1752209191432, clientId: 1752206656090, date: "2025-06-11", category: "额外采买好物成本", itemName: "益生菌含片", supplier: "淘宝", quantity: 1, unitPrice: 765, totalAmount: 765, notes: "for潘先生咽炎（总共买了好几盒", createdAt: "2025-07-11T04:46:31.432Z"},
        {id: 1752209301944, clientId: 1752206656090, date: "2025-06-05", category: "拜访客户成本", itemName: "线下拜访", supplier: "交通", quantity: 1, unitPrice: 1098, totalAmount: 1098, notes: "二人往返+打车", createdAt: "2025-07-11T04:48:21.944Z"},
        {id: 1752209359008, clientId: 1752206656090, date: "2025-07-20", category: "定制补充剂成本", itemName: "第一季度定制补充剂", supplier: "袁名远", quantity: 1, unitPrice: 4800, totalAmount: 4800, notes: "", createdAt: "2025-07-11T04:49:19.008Z"},
        {id: 1752209470909, clientId: 1752206656090, date: "2025-07-11", category: "益生菌成本", itemName: "2个月益生菌", supplier: "金裕", quantity: 1, unitPrice: 3142, totalAmount: 3142, notes: "3122+运费20", createdAt: "2025-07-11T04:51:10.909Z"},
        {id: 1752209749756, clientId: 1752206656090, date: "2025-05-12", category: "拜访客户成本", itemName: "拜访客户", supplier: "交通", quantity: 1, unitPrice: 549.84, totalAmount: 549.84, notes: "住宿99+往返车票184+185，返程打车约56", createdAt: "2025-07-11T04:55:49.756Z"},
        {id: 1752214254431, clientId: 1752214184088, date: "2025-07-11", category: "医疗方案成本", itemName: "医疗方案", supplier: "张医生", quantity: 1, unitPrice: 1200, totalAmount: 1200, notes: "600*2", createdAt: "2025-07-11T06:27:07.798Z"},
        {id: 1752214275527, clientId: 1752214184088, date: "2025-07-11", category: "定制补充剂成本", itemName: "第一季度定制补充剂", supplier: "袁名远", quantity: 1, unitPrice: 4800, totalAmount: 4800, notes: "", createdAt: "2025-07-11T06:11:15.527Z"},
        {id: 1752214612285, clientId: 1752214587578, date: "2025-07-11", category: "定制补充剂成本", itemName: "第一季度定制补充剂", supplier: "袁名远", quantity: 1, unitPrice: 2400, totalAmount: 2400, notes: "", createdAt: "2025-07-11T06:16:52.285Z"},
        {id: 1752214647635, clientId: 1752214587578, date: "2025-07-11", category: "医疗方案成本", itemName: "初次医疗方案", supplier: "张医生", quantity: 1, unitPrice: 300, totalAmount: 300, notes: "", createdAt: "2025-07-11T06:17:27.635Z"},
        {id: 1752214925139, clientId: 1752214587578, date: "2025-07-11", category: "医疗方案成本", itemName: "3.0解读", supplier: "鲁博", quantity: 1, unitPrice: 1500, totalAmount: 1500, notes: "", createdAt: "2025-07-11T06:22:05.139Z"},
        {id: 1752214942242, clientId: 1752214184088, date: "2025-07-11", category: "医疗方案成本", itemName: "3.0解读", supplier: "鲁博", quantity: 1, unitPrice: 3000, totalAmount: 3000, notes: "", createdAt: "2025-07-11T06:22:22.242Z"},
        {id: 1752215184560, clientId: 1752214587578, date: "2025-07-11", category: "医疗方案成本", itemName: "转化提成", supplier: "鲁博", quantity: 1, unitPrice: 600, totalAmount: 600, notes: "", createdAt: "2025-07-11T06:26:24.560Z"},
        {id: 1752215264205, clientId: 1752214587578, date: "2025-07-11", category: "医疗方案成本", itemName: "转化提成", supplier: "鲁博", quantity: 1, unitPrice: 600, totalAmount: 600, notes: "", createdAt: "2025-07-11T06:27:44.205Z"},
        {id: 1752215364711, clientId: 1752215330028, date: "2025-07-11", category: "定制补充剂成本", itemName: "三个季度定制补充剂", supplier: "袁名远", quantity: 1, unitPrice: 7200, totalAmount: 7200, notes: "", createdAt: "2025-07-11T06:29:24.711Z"},
        {id: 1752215429123, clientId: 1752215330028, date: "2025-06-26", category: "医疗方案成本", itemName: "线上回访", supplier: "张医生", quantity: 1, unitPrice: 426.67, totalAmount: 426.67, notes: "32min", createdAt: "2025-07-11T06:30:29.123Z"}
      ]
  });

  // 模态框实例
  const recordModal = new bootstrap.Modal(document.getElementById('recordModal'));
  const addClientModal = new bootstrap.Modal(document.getElementById('addClientModal'));
  const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
  let recordToDelete = null;

  // ====== 工具函数 ======
  const getClient = (clientId) => data.clients.find(c => c.id == clientId);
  
  function getClientQuota(client) {
    if (!client) return 0;
    if (client.quota) return client.quota;
    if (client.name === '潘&徐') return 240000;
    if (client.name === '彭黎') return 150000;
    if (client.type && client.type.includes('Pro')) return 120000;
    return 40000;
  }

  const getClientSpent = (clientId) => data.costRecords
    .filter(r => r.clientId == clientId)
    .reduce((sum, r) => sum + Number(r.totalAmount), 0);

  const getQuotaColor = (spent, quota) => {
    const percent = quota > 0 ? spent / quota : 0;
    if (percent >= 1) return '#e74c3c';
    if (percent >= 0.6) return '#f7b731';
    return '#2e7be6';
  };
  
  // ====== 数据加载与保存 ======
  function loadData() {
    const local = localStorage.getItem(STORAGE_KEY);
    if (local) {
      try {
        data = JSON.parse(local);
        if (!data.clients || !data.costRecords) throw new Error('Data structure incorrect');
      } catch (e) {
        console.error('本地数据损坏，已重置:', e);
        localStorage.removeItem(STORAGE_KEY);
        data = getUserData();
      }
    } else {
      data = getUserData();
    }
  }
  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    renderAll();
  }

  // ====== 视图渲染 ======
  function renderAll() {
    renderDashboard();
  }

  function renderDashboard() {
    const dashboard = document.getElementById('dashboard');
    dashboard.innerHTML = '';
    data.clients.forEach(client => {
      const card = document.createElement('div');
      card.className = 'client-card';
      
      const quota = getClientQuota(client);
      const spent = getClientSpent(client.id);
      const remaining = quota - spent;
      const spentPercent = quota > 0 ? (spent / quota) * 100 : 0;
      const barColor = getQuotaColor(spent, quota);
      const spentRatio = quota > 0 ? spent / quota : 0;

      let alertBadge = '';
      if (spentRatio >= 1) {
          alertBadge = '<span class="danger-badge">超额</span>';
      } else if (spentRatio >= 0.6) {
          alertBadge = '<span class="warning-badge">超60%</span>';
      }

      card.innerHTML = `
        <div class="client-name" data-client-id="${client.id}">${client.name} ${alertBadge}</div>
        <div class="info-row">总额度: <b>￥${quota.toLocaleString()}</b></div>
        <div class="info-row">已花费: <b style="color: ${barColor};">￥${spent.toLocaleString()}</b></div>
        <div class="info-row">剩　余: <b style="color: #28a745;">￥${remaining.toLocaleString()}</b></div>
        <div class="client-pie"><canvas id="pie_${client.id}"></canvas></div>
        <div class="pie-label-container" id="pie_labels_${client.id}"></div>
        <div class="quota-bar-wrapper">
          <div class="quota-bar-bg">
            <div class="quota-bar-fill" style="background:${barColor}; width:${Math.min(100, spentPercent).toFixed(2)}%;"></div>
            <div class="quota-bar-text">${spentPercent.toFixed(1)}% 已用</div>
          </div>
        </div>
      `;
      dashboard.appendChild(card);
      setTimeout(() => renderPieChart(client), 0);
    });
    
    const addCard = document.createElement('div');
    addCard.className = 'add-client-card';
    addCard.innerHTML = '+';
    addCard.onclick = () => addClientModal.show();
    dashboard.appendChild(addCard);
  }

  function renderPieChart(client) {
    const ctx = document.getElementById(`pie_${client.id}`);
    if (!ctx) return;

    const records = data.costRecords.filter(r => r.clientId == client.id);
    const mainCategoryMap = new Map();
    records.forEach(r => {
      const mainCat = getMainCategory(r.category);
      const currentTotal = mainCategoryMap.get(mainCat) || 0;
      mainCategoryMap.set(mainCat, currentTotal + Number(r.totalAmount));
    });

    const labels = [...mainCategoryMap.keys()];
    const values = [...mainCategoryMap.values()];

    if (labels.length === 0) {
        ctx.parentElement.innerHTML = '<div style="color: #999; text-align: center; margin-top: 70px;">暂无消费记录</div>';
        document.getElementById(`pie_labels_${client.id}`).innerHTML = '';
        return;
    }
    
    if (window[`pieChart_${client.id}`]) {
      window[`pieChart_${client.id}`].destroy();
    }

    window[`pieChart_${client.id}`] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: labels.map(label => CATEGORY_COLORS[label] || CATEGORY_COLORS['默认']),
          borderColor: '#fff',
          borderWidth: 3,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          datalabels: {
            display: (context) => {
                const total = context.chart.getDatasetMeta(0).total;
                return (context.dataset.data[context.dataIndex] / total) > 0.05;
            },
            color: '#fff',
            font: { weight: 'bold', size: 12 },
            formatter: (value, context) => {
              const total = context.chart.getDatasetMeta(0).total;
              return (value / total * 100).toFixed(0) + '%';
            },
            textStrokeColor: '#333',
            textStrokeWidth: 2
          }
        },
        cutout: '60%',
      },
      plugins: [ChartDataLabels]
    });

    const labelContainer = document.getElementById(`pie_labels_${client.id}`);
    labelContainer.innerHTML = labels.map(label => 
        `<span class="pie-label" style="background-color: ${CATEGORY_COLORS[label] || CATEGORY_COLORS['默认']}">${label}</span>`
    ).join('');
  }

  function showClientDetail(clientId) {
    const client = getClient(clientId);
    if (!client) return;

    document.getElementById('main-view').style.display = 'none';
    document.getElementById('detail-view').style.display = 'block';
    document.getElementById('detail-title').textContent = `${client.name} - 消费明细`;
    
    document.getElementById('exportClientBtn').onclick = () => exportClientData(clientId);
    // 新增：绑定Excel导出按钮事件
    document.getElementById('exportExcelBtn').onclick = () => exportClientDataAsExcel(clientId);

    renderClientCostTable(clientId);
  }

  function hideClientDetail() {
    document.getElementById('main-view').style.display = 'block';
    document.getElementById('detail-view').style.display = 'none';
    renderAll();
  }

  function renderClientCostTable(clientId) {
    const tbody = document.getElementById('clientCostTableBody');
    tbody.innerHTML = '';
    const records = data.costRecords.filter(r => r.clientId == clientId);
    if (records.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center p-4">暂无记录</td></tr>`;
        return;
    }
    records.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(record => {
        tbody.appendChild(createRecordRow(record));
    });
  }
  
  function createRecordRow(record) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${record.date}</td>
        <td>${record.category}</td>
        <td>${record.itemName}</td>
        <td>${record.supplier || ''}</td>
        <td>${record.quantity}</td>
        <td>￥${Number(record.unitPrice).toLocaleString()}</td>
        <td>￥${Number(record.totalAmount).toLocaleString()}</td>
        <td>${record.notes || ''}</td>
        <td class="table-actions">
          <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${record.id}">编辑</button>
          <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${record.id}">删除</button>
        </td>
      `;
      return tr;
  }

  // ====== 事件处理 ======
  
  document.getElementById('backToDashboardBtn').onclick = hideClientDetail;

  document.getElementById('dashboard').addEventListener('click', (e) => {
      const clientNameDiv = e.target.closest('.client-name');
      if (clientNameDiv) {
          showClientDetail(clientNameDiv.dataset.clientId);
      }
  });

  document.getElementById('addRecordBtn').onclick = () => {
    document.getElementById('recordForm').reset();
    document.getElementById('recordId').value = '';
    document.getElementById('recordModalTitle').textContent = '添加记录';
    updateClientOptions();
    updateCategoryOptions(); // 更新分类下拉框
    document.getElementById('recordDate').valueAsDate = new Date();
    recordModal.show();
  };
  
  const quantityInput = document.getElementById('recordQuantity');
  const unitPriceInput = document.getElementById('recordUnitPrice');
  quantityInput.addEventListener('input', updateRecordTotal);
  unitPriceInput.addEventListener('input', updateRecordTotal);
  function updateRecordTotal() {
      const quantity = parseFloat(quantityInput.value) || 0;
      const unitPrice = parseFloat(unitPriceInput.value) || 0;
      document.getElementById('recordTotalAmount').value = (quantity * unitPrice).toFixed(2);
  }

  document.getElementById('saveRecordBtn').onclick = () => {
    const form = document.getElementById('recordForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const id = document.getElementById('recordId').value;
    const recordData = {
      id: id ? Number(id) : Date.now(),
      clientId: Number(document.getElementById('recordClient').value),
      date: document.getElementById('recordDate').value,
      category: document.getElementById('recordCategory').value, // 从下拉框获取
      itemName: document.getElementById('recordItemName').value.trim(),
      supplier: document.getElementById('recordSupplier').value.trim(),
      quantity: Number(document.getElementById('recordQuantity').value),
      unitPrice: Number(document.getElementById('recordUnitPrice').value),
      totalAmount: Number(document.getElementById('recordTotalAmount').value),
      notes: document.getElementById('recordNotes').value.trim(),
      createdAt: new Date().toISOString()
    };

    if (id) {
      const index = data.costRecords.findIndex(r => r.id == id);
      if (index !== -1) data.costRecords[index] = recordData;
    } else {
      data.costRecords.push(recordData);
    }
    saveData();
    recordModal.hide();
    
    if (document.getElementById('detail-view').style.display === 'block') {
        renderClientCostTable(recordData.clientId);
    }
  };

  document.body.addEventListener('click', e => {
      if (e.target.classList.contains('edit-btn')) handleEdit(e.target.dataset.id);
      if (e.target.classList.contains('delete-btn')) handleDelete(e.target.dataset.id);
  });

  function handleEdit(id) {
      const record = data.costRecords.find(r => r.id == id);
      if (!record) return;
      
      document.getElementById('recordForm').reset();
      updateClientOptions();
      updateCategoryOptions(); // 更新分类下拉框

      document.getElementById('recordId').value = record.id;
      document.getElementById('recordDate').value = record.date;
      document.getElementById('recordClient').value = record.clientId;
      document.getElementById('recordCategory').value = record.category;
      document.getElementById('recordItemName').value = record.itemName;
      document.getElementById('recordSupplier').value = record.supplier;
      document.getElementById('recordQuantity').value = record.quantity;
      document.getElementById('recordUnitPrice').value = record.unitPrice;
      document.getElementById('recordTotalAmount').value = record.totalAmount;
      document.getElementById('recordNotes').value = record.notes;
      
      document.getElementById('recordModalTitle').textContent = '编辑记录';
      recordModal.show();
  }

  function handleDelete(id) {
      recordToDelete = id;
      deleteConfirmModal.show();
  }

  document.getElementById('confirmDeleteBtn').onclick = () => {
      if (recordToDelete) {
          const record = data.costRecords.find(r => r.id == recordToDelete);
          data.costRecords = data.costRecords.filter(r => r.id != recordToDelete);
          saveData();
          
          if (document.getElementById('detail-view').style.display === 'block' && record) {
              renderClientCostTable(record.clientId);
          }
          recordToDelete = null;
      }
      deleteConfirmModal.hide();
  };

  document.getElementById('newClientType').addEventListener('change', (e) => {
      document.getElementById('manualQuotaWrapper').style.display = e.target.value === '特殊' ? 'block' : 'none';
  });

  document.getElementById('saveNewClientBtn').onclick = () => {
    const name = document.getElementById('newClientName').value.trim();
    const type = document.getElementById('newClientType').value;
    let quota = 0;
    if (type === '特殊') {
        quota = parseFloat(document.getElementById('newClientQuota').value);
        if (isNaN(quota) || quota <= 0) {
            alert('请为特殊类型客户填写有效的额度！');
            return;
        }
    }
    if (!name) {
      alert('请填写客户姓名！');
      return;
    }
    const newClient = {
      id: Date.now(),
      name: name,
      type: type,
      createdAt: new Date().toISOString()
    };
    if (quota > 0) {
        newClient.quota = quota;
    }
    data.clients.push(newClient);
    saveData();
    addClientModal.hide();
    document.getElementById('newClientName').value = '';
    document.getElementById('newClientQuota').value = '';
    document.getElementById('manualQuotaWrapper').style.display = 'none';
  };
  
  function updateClientOptions() {
    const sel = document.getElementById('recordClient');
    const currentVal = sel.value;
    sel.innerHTML = '';
    data.clients.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.name;
      sel.appendChild(opt);
    });
    sel.value = currentVal;
  }

  function updateCategoryOptions() {
    const sel = document.getElementById('recordCategory');
    sel.innerHTML = '';
    for (const mainCat in CATEGORY_STRUCTURE) {
        const optGroup = document.createElement('optgroup');
        optGroup.label = mainCat;
        CATEGORY_STRUCTURE[mainCat].forEach(subCat => {
            const opt = document.createElement('option');
            opt.value = subCat;
            opt.textContent = subCat;
            optGroup.appendChild(opt);
        });
        sel.appendChild(optGroup);
    }
  }

  // ====== 导入/导出功能 ======
  document.getElementById('importBtn').onclick = () => document.getElementById('importFile').click();
  document.getElementById('exportBtn').onclick = () => exportData(data, `TimeCure_数据备份`);

  function exportClientData(clientId) {
      const client = getClient(clientId);
      const clientRecords = data.costRecords.filter(r => r.clientId == clientId);
      const exportObj = {
          clients: [client],
          costRecords: clientRecords
      };
      exportData(exportObj, `TimeCure_${client.name}_明细`);
  }

  function exportData(exportObj, baseFileName) {
    const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${baseFileName}_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // 新增：导出为Excel的功能
  function exportClientDataAsExcel(clientId) {
    const client = getClient(clientId);
    const records = data.costRecords.filter(r => r.clientId == clientId).sort((a,b) => new Date(b.date) - new Date(a.date));
    if (!client || records.length === 0) {
        alert('没有可导出的数据。');
        return;
    }

    const headers = ['日期', '分类', '项目', '供应商', '数量', '单价', '总额', '备注'];
    const dataForSheet = records.map(r => [
        r.date,
        r.category,
        r.itemName,
        r.supplier || '',
        r.quantity,
        r.unitPrice,
        r.totalAmount,
        r.notes || ''
    ]);

    // 添加总计行
    const totalSpent = records.reduce((sum, r) => sum + r.totalAmount, 0);
    dataForSheet.push([]); // 空行
    dataForSheet.push(['', '', '', '', '', '总计', totalSpent, '']);

    const ws = XLSX.utils.aoa_to_sheet([headers, ...dataForSheet]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '消费明细');

    const fileName = `TimeCure_${client.name}_明细_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(wb, fileName);
  }

  document.getElementById('importFile').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const imported = JSON.parse(event.target.result);
        if (Array.isArray(imported.clients) && Array.isArray(imported.costRecords)) {
            data.clients = imported.clients;
            data.costRecords = imported.costRecords;
            saveData();
            alert('数据导入成功！将覆盖现有数据。');
        } else {
            throw new Error('数据格式不正确');
        }
      } catch (err) {
        alert('导入失败：' + err.message);
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  };

  // ====== 初始化 ======
  loadData();
  renderAll();
});
</script>
</body>
</html>
